---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  // Generate paths for published and unlisted stories (not unpublished)
  const stories = await getCollection('stories', ({ data }) => data.state !== 'unpublished');
  return stories.map(story => ({
    params: { storySlug: story.slug },
    props: { story },
  }));
}

const { story } = Astro.props;

// Get published chapters for this story (visible in list)
const allChapters = await getCollection('chapters', ({ data }) => data.state === 'published');
const chapters = allChapters
  .filter(ch => ch.data.storySlug === story.slug)
  .sort((a, b) => a.data.chapterNumber - b.data.chapterNumber);
---

<Layout title={story.data.title} description={story.data.description}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <nav class="mb-6 text-sm text-gray-600 dark:text-gray-400">
      <a href="/" class="hover:text-blue-600 dark:hover:text-blue-400">Library</a>
      <span class="mx-2">/</span>
      <span>{story.data.title}</span>
    </nav>

    <!-- Story header -->
    <header class="mb-8">
      <div class="flex items-start justify-between mb-4">
        <h1 class="text-4xl font-bold">{story.data.title}</h1>
        <span class={`px-3 py-1 rounded-full text-sm font-medium ${
          story.data.status === 'complete' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' :
          story.data.status === 'ongoing' ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' :
          'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200'
        }`}>
          {story.data.status}
        </span>
      </div>

      <p class="text-lg text-gray-600 dark:text-gray-400">
        {story.data.description}
      </p>
    </header>

    <!-- Chapter list -->
    {chapters.length === 0 ? (
      <p class="text-gray-600 dark:text-gray-400 text-center py-12">
        Coming soon! No chapters published yet.
      </p>
    ) : (
      <>
        <div class="mb-6 flex gap-4">
          <a
            href={`/${story.slug}/${chapters[0].slug.split('/').pop()}`}
            class="inline-block px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
          >
            Start Reading
          </a>
          <a
            id="resumeReadingBtn"
            href="#"
            class="hidden px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors"
          >
            Resume Reading
          </a>
        </div>

        <div class="space-y-4">
          <h2 class="text-2xl font-bold mb-4">Chapters ({chapters.length})</h2>
          {chapters.map(chapter => (
            <article class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="text-lg font-semibold mb-1">
                    <a
                      href={`/${story.slug}/${chapter.slug.split('/').pop()}`}
                      class="hover:text-blue-600 dark:hover:text-blue-400"
                    >
                      Chapter {chapter.data.chapterNumber}: {chapter.data.title}
                    </a>
                  </h3>
                  {chapter.data.summary && (
                    <p class="text-gray-600 dark:text-gray-400 text-sm">
                      {chapter.data.summary}
                    </p>
                  )}
                </div>
                <time class="text-sm text-gray-500 ml-4">
                  {chapter.data.publishDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  })}
                </time>
              </div>
            </article>
          ))}
        </div>
      </>
    )}
  </div>

  <script is:inline define:vars={{ storySlug: story.slug }}>
    // Check if there's a last chapter read for this story
    const lastChapterSlug = localStorage.getItem(`lastChapter-${storySlug}`);

    if (lastChapterSlug) {
      const resumeBtn = document.getElementById('resumeReadingBtn');
      if (resumeBtn) {
        resumeBtn.href = `/${storySlug}/${lastChapterSlug}`;
        resumeBtn.classList.remove('hidden');
      }
    }
  </script>
</Layout>
